# Description
Run openmrs reference application and mysql as disposable docker containers
for msf demo server.

The docker image used was generated by OpenMRS SDK, and deployed to Docker hub (check <https://hub.docker.com/r/openmrs/openmrs-reference-application-distro/>

## Running it locally

To start both containers:
```
$ docker-compose down -v
$ OPENMRS_VERSION=2.5 docker-compose up
```
If you don't add a _OPENMRS_VERSION_ variable, it will use `demo` docker tag.

Application will be eventually accessible on http://localhost:8084/openmrs.
Credentials on shipped demo data:
  - Username: admin
  - Password: Admin123

Use _CTRL + C_ to stop it all containers. But make sure to destroy containers to delete any
left overs volumes and data when doing changes to the docker configuration and images:

```
$ docker-compose down -v
```

### Generate demo data / database from scratch
If you want to generate the SQL with the demo data:

  - Comment docker volume `./dbdump` to ignore previous SQL dumps
  - Uncomment docker volume `openmrs-referenceapplication-mysql-data` to allow
  data being persisted between docker runs.
  - Change environment variables _DB_CREATE_TABLES_ and _DB_AUTO_UPDATE_ to true
  to allow OpenMRS to recreate the database schema.
  - Run `docker-compose up` and wait for the application to load
  - Login to OpenMRS and change the global setting
  `referencedemodata.createDemoPatientsOnNextStartup` to 500
  - Run `docker-compose down && docker-compose up` to restart the application.
  This will take quite a while. Wait for the application to load again.
  - Enter the DB docker container (`docker exec -it <container_db_id> bash`)
  - From inside the container, run `mysql --user=openmrs --password=Admin123 openmrs`
  and add the triggers from <https://issues.openmrs.org/browse/ITSM-3917>
  - From inside the container, run:
  `mysqldump --user=openmrs --password=$PASSWORD openmrs > /tmp/dump.sql`
  - From outside the container, copy the dump file to your machine:
  `docker cp <container_db_id>:/tmp/dump.sql .`
  - Due to <https://issues.openmrs.org/browse/SDK-201>, search on the SQL for
   `search.indexVersion` and make it empty.
  - Also, change `atlas.stopAskingToConfigure` to `true` on the SQL file <https://talk.openmrs.org/t/new-demo-server-is-ready-for-tests/9685/12?u=cintiadr>

You'll want to replace the SQL file in dbdump, but no other changes should be committed.


### Restoring a dump
- Add msf-2018-06-12.sql (dump file) into dbdump folder if u wish to share it or replace existing
- Copy dump file into mysql docker image
```
docker cp dbdump/msf-2018-06-12.sql msf_openmrs-referenceapplication-mysql_1:/tmp/dump.sql
```
- Log into the mysql docker instance's shell
```
docker exec -it msf_openmrs-referenceapplication-mysql_1 bash
```
- restore backup to replace existing database
```
mysql -uopenmrs -pAdmin123 -e "drop database openmrs";
mysql -uopenmrs -pAdmin123 -e "create database openmrs";
mysql -uopenmrs -pAdmin123 openmrs < /tmp/dump.sql;
rm /tmp/dump.sql;
```
